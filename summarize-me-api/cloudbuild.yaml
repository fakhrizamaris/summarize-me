steps:
  # 1. Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-t',
        'asia-southeast2-docker.pkg.dev/$PROJECT_ID/summarize-api/summarize-api:latest',
        '.', # Build dari root project
        '-f', # Tentukan Dockerfile secara eksplisit
        'summarize-me-api/Dockerfile' # Path Dockerfile
      ]
    # 'dir' tidak perlu jika build context adalah root dan Dockerfile path ditentukan

  # 2. Push image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'push',
        'asia-southeast2-docker.pkg.dev/$PROJECT_ID/summarize-api/summarize-api:latest'
      ]

  # 3. Deploy ke Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run', 'deploy', 'summarize-api', # Nama service Cloud Run
        '--image', 'asia-southeast2-docker.pkg.dev/$PROJECT_ID/summarize-api/summarize-api:latest',
        '--region', 'asia-southeast2',
        '--platform', 'managed',
        '--allow-unauthenticated', # Sesuaikan jika perlu autentikasi IAM/IAP
        '--port', '8080',
        # Tambahkan --set-env-vars di sini atau konfigurasikan di Cloud Run UI/gcloud terpisah
        # Contoh: '--set-env-vars=FIREBASE_PROJECT_ID=summarizeme-project,FRONTEND_URL=https://summarizemeai.vercel.app',
        # Untuk GEMINI_API_KEY, gunakan Secret Manager: '--set-secrets=GEMINI_API_KEY=nama-secret:versi-terbaru'
      ]

# Substitutions (opsional)
substitutions:
  _SERVICE_NAME: 'summarize-api'
  _REGION: 'asia-southeast2'

options:
  logging: CLOUD_LOGGING_ONLY